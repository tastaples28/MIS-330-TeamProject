<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Checkout - Campus ReHome</title>
  
  <!-- Bootstrap 5 CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  />
  
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  
  <!-- Custom CSS -->
  <link rel="stylesheet" href="./styles/main.css" />
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand fw-bold" href="./index.html">
        <i class="bi bi-house-door"></i> Campus ReHome
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link" href="./index.html">Shop</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="./furniture.html">Browse All</a>
          </li>
        </ul>
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="./index.html">
              <i class="bi bi-cart3"></i> Cart
            </a>
          </li>
          <li class="nav-item" id="profileNavItem">
            <a class="nav-link" href="./profile.html">My Account</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container my-5">
    <div class="row">
      <div class="col-lg-8">
        <h2 class="mb-4">Checkout</h2>
        
        <!-- Order Summary -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">Order Summary</h5>
          </div>
          <div class="card-body" id="orderSummary">
            <!-- Items will be loaded here -->
          </div>
        </div>

        <!-- Customer Info -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">Customer Information</h5>
          </div>
          <div class="card-body">
            <form id="checkoutForm">
              <div class="row mb-3">
                <div class="col-md-6">
                  <label class="form-label">First Name *</label>
                  <input type="text" class="form-control" id="checkoutFirstName" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Last Name *</label>
                  <input type="text" class="form-control" id="checkoutLastName" required>
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Email *</label>
                <input type="email" class="form-control" id="checkoutEmail" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Phone</label>
                <input type="tel" class="form-control" id="checkoutPhone">
              </div>
              <div class="mb-3">
                <label class="form-label">Shipping Address *</label>
                <input type="text" class="form-control" id="checkoutAddress" required>
              </div>
            </form>
          </div>
        </div>

        <!-- Payment Method -->
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Payment Method</h5>
          </div>
          <div class="card-body">
            <select class="form-select" id="paymentMethod" required>
              <option value="">Select payment method...</option>
              <option value="Cash">Cash (In-Store Pickup)</option>
              <option value="Credit Card">Credit Card</option>
              <option value="Debit Card">Debit Card</option>
              <option value="Venmo">Venmo</option>
              <option value="PayPal">PayPal</option>
            </select>
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="card sticky-top" style="top: 20px;">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Order Total</h5>
          </div>
          <div class="card-body">
            <div class="d-flex justify-content-between mb-2">
              <span>Subtotal:</span>
              <span id="subtotal">$0.00</span>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span>Tax (8%):</span>
              <span id="tax">$0.00</span>
            </div>
            <hr>
            <div class="d-flex justify-content-between mb-3">
              <strong>Total:</strong>
              <strong class="text-success" id="total">$0.00</strong>
            </div>
            <button class="btn btn-primary w-100 btn-lg" onclick="submitOrder()">
              <i class="bi bi-check-circle"></i> Place Order
            </button>
            <a href="./index.html" class="btn btn-outline-secondary w-100 mt-2">Continue Shopping</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer class="mt-5 py-4 bg-light">
    <div class="container text-center">
      <p class="mb-0">&copy; 2024 Campus ReHome - CollegeTown Furniture Platform | Roll Tide! üêò</p>
    </div>
  </footer>

  <!-- Bootstrap 5 JS Bundle -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"
  ></script>
  
  <script>
    function getApiBaseUrl() {
      if (window.location.protocol === 'file:') {
        return 'http://localhost:5000/api';
      }
      return '/api';
    }

    let shoppingCart = JSON.parse(localStorage.getItem('shoppingCart') || '[]');
    let currentUser = null;

    async function loadCheckout() {
      // Check if user is logged in
      const userToken = localStorage.getItem('userToken');
      const userId = localStorage.getItem('userId');
      const userType = localStorage.getItem('userType');

      if (!userToken || !userId) {
        alert('Please login to checkout');
        window.location.href = './login.html';
        return;
      }

      // Load user info
      try {
        const endpoint = userType === 'employee' ? 'employees' : 'customers';
        const response = await fetch(`${getApiBaseUrl()}/${endpoint}/${userId}`);
        if (response.ok) {
          currentUser = await response.json();
          // Pre-fill form
          document.getElementById('checkoutFirstName').value = currentUser.first_name || currentUser.firstName || '';
          document.getElementById('checkoutLastName').value = currentUser.last_name || currentUser.lastName || '';
          document.getElementById('checkoutEmail').value = currentUser.email || '';
          document.getElementById('checkoutPhone').value = currentUser.phone || currentUser.phone_number || '';
          document.getElementById('checkoutAddress').value = currentUser.address || '';
        }
      } catch (error) {
        console.error('Error loading user:', error);
      }

      // Display cart items
      displayOrderSummary();
      calculateTotal();
    }

    function displayOrderSummary() {
      const summary = document.getElementById('orderSummary');
      if (shoppingCart.length === 0) {
        summary.innerHTML = '<p class="text-muted">Your cart is empty. <a href="./index.html">Continue shopping</a></p>';
        return;
      }

      summary.innerHTML = shoppingCart.map(item => `
        <div class="d-flex justify-content-between align-items-center border-bottom pb-3 mb-3">
          <div>
            <h6 class="mb-1">${item.name}</h6>
            <small class="text-muted">Quantity: ${item.quantity}</small>
          </div>
          <div class="text-end">
            <strong>$${(item.price * item.quantity).toFixed(2)}</strong>
          </div>
        </div>
      `).join('');
    }

    function calculateTotal() {
      const subtotal = shoppingCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      const tax = subtotal * 0.08;
      const total = subtotal + tax;

      document.getElementById('subtotal').textContent = '$' + subtotal.toFixed(2);
      document.getElementById('tax').textContent = '$' + tax.toFixed(2);
      document.getElementById('total').textContent = '$' + total.toFixed(2);
    }

    async function submitOrder() {
      const form = document.getElementById('checkoutForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const paymentMethod = document.getElementById('paymentMethod').value;
      if (!paymentMethod) {
        alert('Please select a payment method');
        return;
      }

      if (shoppingCart.length === 0) {
        alert('Your cart is empty');
        return;
      }

      const userId = localStorage.getItem('userId');
      const userType = localStorage.getItem('userType');
      const employeeId = userType === 'employee' ? userId : null;

      // Get first available employee if customer
      let assignedEmployeeId = employeeId;
      if (!assignedEmployeeId) {
        try {
          const empResponse = await fetch(`${getApiBaseUrl()}/employees?format=json`);
          if (empResponse.ok) {
            const empData = await empResponse.json();
            const employees = empData.employees || [];
            if (employees.length > 0) {
              assignedEmployeeId = employees[0].employee_id || employees[0].employeeId;
            }
          }
        } catch (error) {
          console.error('Error getting employee:', error);
        }
      }

      if (!assignedEmployeeId) {
        alert('Unable to process order. Please contact support.');
        return;
      }

      // Calculate totals
      const subtotal = shoppingCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      const tax = subtotal * 0.08;
      const total = subtotal + tax;

      // Create transaction
      const transactionData = {
        CustomerId: parseInt(userId),
        EmployeeId: parseInt(assignedEmployeeId),
        TransactionDate: new Date().toISOString().split('T')[0],
        TotalAmount: total,
        PaymentMethod: paymentMethod,
        Status: 'Pending',
        Details: shoppingCart.map(item => ({
          FurnitureId: item.id,
          Quantity: item.quantity,
          SalePrice: item.price
        }))
      };

      try {
        const response = await fetch(`${getApiBaseUrl()}/transactions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(transactionData)
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.message || 'Failed to place order');
        }

        // Clear cart
        shoppingCart = [];
        localStorage.removeItem('shoppingCart');

        // Show success
        alert('Order placed successfully! Your order number is: ' + (await response.json()).transaction_id);
        window.location.href = './index.html';
      } catch (error) {
        console.error('Error placing order:', error);
        alert('Error placing order: ' + error.message);
      }
    }

    // Initialize
    loadCheckout();
  </script>
</body>
</html>


