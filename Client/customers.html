<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Customers - Campus ReHome</title>
  
  <!-- Bootstrap 5 CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  />
  
  <!-- Custom CSS -->
  <link rel="stylesheet" href="./styles/main.css" />
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <a class="navbar-brand" href="./index.html">üè† Campus ReHome</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="./index.html">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="./furniture.html">Furniture</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="./customers.html">Customers</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="./employees.html">Employees</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="./transactions.html">Transactions</a>
          </li>
          <li class="nav-item" id="loginNavItem">
            <a class="nav-link" href="./login.html">Login</a>
          </li>
          <li class="nav-item" id="profileNavItem" style="display: none;">
            <a class="nav-link" href="./profile.html">Profile</a>
          </li>
          <li class="nav-item" id="logoutNavItem" style="display: none;">
            <a class="nav-link" href="#" onclick="logout(); return false;">Logout</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h1 class="mb-2">üë• Customers</h1>
        <p class="text-muted mb-0">Manage customer information</p>
      </div>
      <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCustomerModal">
        <span>+</span> Add New Customer
      </button>
    </div>

    <div class="card">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th>ID</th>
                <th>First Name</th>
                <th>Last Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Address</th>
                <th>Join Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="customersTableBody">
              <tr>
                <td colspan="8" class="text-center">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Customer Modal -->
  <div class="modal fade" id="addCustomerModal" tabindex="-1" aria-labelledby="addCustomerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addCustomerModalLabel">Add New Customer</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addCustomerForm">
            <div class="mb-3">
              <label for="firstName" class="form-label">First Name *</label>
              <input type="text" class="form-control" id="firstName" required>
            </div>
            <div class="mb-3">
              <label for="lastName" class="form-label">Last Name *</label>
              <input type="text" class="form-control" id="lastName" required>
            </div>
            <div class="mb-3">
              <label for="email" class="form-label">Email *</label>
              <input type="email" class="form-control" id="email" required>
            </div>
            <div class="mb-3">
              <label for="phone" class="form-label">Phone</label>
              <input type="tel" class="form-control" id="phone">
            </div>
            <div class="mb-3">
              <label for="password" class="form-label">Password *</label>
              <input type="password" class="form-control" id="password" required>
            </div>
            <div class="mb-3">
              <label for="address" class="form-label">Address</label>
              <input type="text" class="form-control" id="address">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="submitCustomerForm()">Add Customer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Customer Modal -->
  <div class="modal fade" id="editCustomerModal" tabindex="-1" aria-labelledby="editCustomerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editCustomerModalLabel">Edit Customer</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editCustomerForm">
            <input type="hidden" id="editCustomerId">
            <div class="mb-3">
              <label for="editFirstName" class="form-label">First Name *</label>
              <input type="text" class="form-control" id="editFirstName" required>
            </div>
            <div class="mb-3">
              <label for="editLastName" class="form-label">Last Name *</label>
              <input type="text" class="form-control" id="editLastName" required>
            </div>
            <div class="mb-3">
              <label for="editEmail" class="form-label">Email *</label>
              <input type="email" class="form-control" id="editEmail" required>
            </div>
            <div class="mb-3">
              <label for="editPhone" class="form-label">Phone</label>
              <input type="tel" class="form-control" id="editPhone">
            </div>
            <div class="mb-3">
              <label for="editPassword" class="form-label">Password</label>
              <input type="password" class="form-control" id="editPassword" placeholder="Leave blank to keep existing password">
              <small class="text-muted">Enter new password or leave blank to keep existing</small>
            </div>
            <div class="mb-3">
              <label for="editAddress" class="form-label">Address</label>
              <input type="text" class="form-control" id="editAddress">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="submitEditCustomer()">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <footer class="mt-5">
    <div class="container">
      <p class="mb-0">&copy; 2024 Campus ReHome - CollegeTown Furniture Platform | Roll Tide! üêò</p>
    </div>
  </footer>

  <!-- Bootstrap 5 JS Bundle -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"
  ></script>
  
  <script>
    // Get API base URL - works for both file:// and http://
    function getApiBaseUrl() {
      if (window.location.protocol === 'file:') {
        // If opening file directly, try to use localhost (server must be running)
        return 'http://localhost:5000/api';
      }
      return '/api';
    }

    async function loadCustomers() {
      try {
        const response = await fetch(`${getApiBaseUrl()}/customers?format=json`);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (!data || !data.customers) {
          console.warn('Unexpected API response:', data);
          displayCustomers([]);
          return;
        }
        
        displayCustomers(data.customers);
      } catch (error) {
        console.error('Error loading customers:', error);
        const errorMsg = window.location.protocol === 'file:' 
          ? 'Cannot load data. Please start the server: cd api && dotnet run'
          : 'Error loading customers from database. Check console for details.';
        document.getElementById('customersTableBody').innerHTML = 
          `<tr><td colspan="8" class="text-center text-danger">${errorMsg}</td></tr>`;
      }
    }

    function displayCustomers(customers) {
      const tbody = document.getElementById('customersTableBody');
      if (customers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">No customers found</td></tr>';
        return;
      }
      
      tbody.innerHTML = customers.map(customer => {
        const joinDate = new Date(customer.join_date || customer.joinDate || customer.JoinDate).toLocaleDateString();
        // Handle both snake_case and camelCase/PascalCase - check if value exists (not just falsy)
        const firstName = (customer.first_name !== undefined && customer.first_name !== null && customer.first_name !== '') 
          ? customer.first_name 
          : (customer.firstName !== undefined && customer.firstName !== null && customer.firstName !== '')
          ? customer.firstName
          : (customer.FirstName !== undefined && customer.FirstName !== null && customer.FirstName !== '')
          ? customer.FirstName
          : 'N/A';
        const lastName = (customer.last_name !== undefined && customer.last_name !== null && customer.last_name !== '') 
          ? customer.last_name 
          : (customer.lastName !== undefined && customer.lastName !== null && customer.lastName !== '')
          ? customer.lastName
          : (customer.LastName !== undefined && customer.LastName !== null && customer.LastName !== '')
          ? customer.LastName
          : 'N/A';
        const customerId = customer.customer_id || customer.customerId || customer.CustomerId || '';
        return `
          <tr>
            <td>${customerId}</td>
            <td>${firstName}</td>
            <td>${lastName}</td>
            <td>${customer.email || customer.Email || '-'}</td>
            <td>${customer.phone || customer.Phone || '-'}</td>
            <td>${customer.address || customer.Address || '-'}</td>
            <td>${joinDate}</td>
            <td>
              <button onclick="openEditCustomerModal(${customerId})" class="btn btn-sm btn-outline-primary">Edit</button>
              <button onclick="deleteCustomer(${customerId})" class="btn btn-sm btn-outline-danger">Delete</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    async function deleteCustomer(id) {
      if (!confirm('Are you sure you want to delete this customer?')) return;
      
      try {
        const response = await fetch(`${getApiBaseUrl()}/customers/${id}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          loadCustomers(); // Reload the list
        } else {
          alert('Error deleting customer');
        }
      } catch (error) {
        console.error('Error deleting customer:', error);
        alert('Error deleting customer');
      }
    }

    async function submitCustomerForm() {
      const form = document.getElementById('addCustomerForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const customerData = {
        FirstName: document.getElementById('firstName').value,
        LastName: document.getElementById('lastName').value,
        Email: document.getElementById('email').value,
        Phone: document.getElementById('phone').value || null,
        UserPassword: document.getElementById('password').value,
        Address: document.getElementById('address').value || null
      };

      try {
        const response = await fetch(`${getApiBaseUrl()}/customers`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(customerData)
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
        }

        // Close modal and reset form
        const modal = bootstrap.Modal.getInstance(document.getElementById('addCustomerModal'));
        modal.hide();
        form.reset();

        // Reload customers list
        loadCustomers();

        // Show success message
        alert('Customer added successfully!');
      } catch (error) {
        console.error('Error adding customer:', error);
        alert('Error adding customer: ' + error.message);
      }
    }

    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('userToken');
        localStorage.removeItem('userId');
        localStorage.removeItem('userType');
        localStorage.removeItem('userName');
        localStorage.removeItem('userEmail');
        window.location.href = './index.html';
      }
    }

    // Update navigation based on login status
    const userToken = localStorage.getItem('userToken');
    if (userToken) {
      document.getElementById('loginNavItem').style.display = 'none';
      document.getElementById('profileNavItem').style.display = 'block';
      document.getElementById('logoutNavItem').style.display = 'block';
    }

    let currentCustomerPassword = '';
    let currentEditCustomerData = null; // Store customer data for form population

    async function openEditCustomerModal(id) {
      try {
        const response = await fetch(`${getApiBaseUrl()}/customers/${id}`);
        if (!response.ok) {
          throw new Error('Failed to load customer data');
        }
        
        const customer = await response.json();
        
        console.log('Customer data received:', customer); // Debug log
        
        // Handle both snake_case (from API) and camelCase/PascalCase formats
        // Check for actual values, not just truthy (to handle empty strings)
        const customerId = customer.customer_id ?? customer.customerId ?? customer.CustomerId ?? '';
        const firstName = customer.first_name ?? customer.firstName ?? customer.FirstName ?? '';
        const lastName = customer.last_name ?? customer.lastName ?? customer.LastName ?? '';
        const email = customer.email ?? customer.Email ?? '';
        const phone = customer.phone ?? customer.Phone ?? '';
        const address = customer.address ?? customer.Address ?? '';
        const password = customer.userpassword ?? customer.userPassword ?? customer.UserPassword ?? '';
        
        // Store current password and customer data
        currentCustomerPassword = password;
        currentEditCustomerData = {
          customerId,
          firstName,
          lastName,
          email,
          phone: phone ?? '',
          address: address ?? ''
        };
        
        console.log('Parsed values:', { customerId, firstName, lastName, email, phone, address }); // Debug log
        console.log('Stored customer data:', currentEditCustomerData);
        
        // Populate form - use nullish coalescing to preserve empty strings
        const editCustomerIdEl = document.getElementById('editCustomerId');
        const editFirstNameEl = document.getElementById('editFirstName');
        const editLastNameEl = document.getElementById('editLastName');
        const editEmailEl = document.getElementById('editEmail');
        const editPhoneEl = document.getElementById('editPhone');
        const editAddressEl = document.getElementById('editAddress');
        const editPasswordEl = document.getElementById('editPassword');
        
        if (editCustomerIdEl) editCustomerIdEl.value = customerId;
        if (editFirstNameEl) editFirstNameEl.value = firstName;
        if (editLastNameEl) editLastNameEl.value = lastName;
        if (editEmailEl) editEmailEl.value = email;
        if (editPhoneEl) editPhoneEl.value = phone ?? '';
        if (editAddressEl) editAddressEl.value = address ?? '';
        if (editPasswordEl) {
          editPasswordEl.value = ''; // Don't pre-fill password
          editPasswordEl.required = false; // Make optional
        }
        
        console.log('Form populated with:', { customerId, firstName, lastName, email, phone, address }); // Debug log
        
        // Show modal first, then populate (Bootstrap might reset form on show)
        const modalElement = document.getElementById('editCustomerModal');
        const modal = new bootstrap.Modal(modalElement);
        
        // Function to populate form
        const populateForm = () => {
          if (editCustomerIdEl) editCustomerIdEl.value = customerId;
          if (editFirstNameEl) {
            editFirstNameEl.value = firstName;
            console.log('Set firstName to:', firstName, 'Actual value:', editFirstNameEl.value);
          }
          if (editLastNameEl) {
            editLastNameEl.value = lastName;
            console.log('Set lastName to:', lastName, 'Actual value:', editLastNameEl.value);
          }
          if (editEmailEl) editEmailEl.value = email;
          if (editPhoneEl) editPhoneEl.value = phone ?? '';
          if (editAddressEl) editAddressEl.value = address ?? '';
          if (editPasswordEl) {
            editPasswordEl.value = '';
            editPasswordEl.required = false;
          }
        };
        
        // Populate immediately
        populateForm();
        
        // Wait for modal to be shown, then populate again (in case Bootstrap reset it)
        modalElement.addEventListener('shown.bs.modal', function onModalShown() {
          console.log('Modal shown, repopulating form...');
          populateForm();
          
          // Verify values are set
          setTimeout(() => {
            console.log('Form field values after modal shown:', {
              firstName: editFirstNameEl?.value,
              lastName: editLastNameEl?.value,
              email: editEmailEl?.value,
              customerId: editCustomerIdEl?.value,
              firstNameElement: editFirstNameEl,
              lastNameElement: editLastNameEl
            });
          }, 100);
          
          // Remove listener after first use
          modalElement.removeEventListener('shown.bs.modal', onModalShown);
        }, { once: true });
        
        modal.show();
        
        // Also populate after a short delay as backup
        setTimeout(() => {
          populateForm();
          console.log('Backup population - Form values:', {
            firstName: editFirstNameEl?.value,
            lastName: editLastNameEl?.value
          });
        }, 200);
      } catch (error) {
        console.error('Error loading customer:', error);
        alert('Error loading customer data: ' + error.message);
      }
    }

    async function submitEditCustomer() {
      const form = document.getElementById('editCustomerForm');
      // Remove password requirement temporarily
      const passwordField = document.getElementById('editPassword');
      const passwordRequired = passwordField.required;
      passwordField.required = false;
      
      if (!form.checkValidity()) {
        passwordField.required = passwordRequired;
        form.reportValidity();
        return;
      }
      passwordField.required = passwordRequired;

      const id = document.getElementById('editCustomerId').value;
      const newPassword = document.getElementById('editPassword').value.trim();
      
      // If password is empty, we need to fetch current password first
      let passwordToUse = newPassword;
      if (!passwordToUse) {
        if (!currentCustomerPassword) {
          // Fetch current customer to get password
          try {
            const getResponse = await fetch(`${getApiBaseUrl()}/customers/${id}`);
            if (getResponse.ok) {
              const currentCustomer = await getResponse.json();
              currentCustomerPassword = currentCustomer.userpassword || currentCustomer.userPassword || '';
              passwordToUse = currentCustomerPassword;
            } else {
              throw new Error('Could not retrieve current password');
            }
          } catch (err) {
            alert('Error: Could not retrieve current password. Please enter a new password.');
            return;
          }
        } else {
          passwordToUse = currentCustomerPassword;
        }
      }
      
      // Get form values and validate
      const firstNameInput = document.getElementById('editFirstName');
      const lastNameInput = document.getElementById('editLastName');
      const emailInput = document.getElementById('editEmail');
      const phoneInput = document.getElementById('editPhone');
      const addressInput = document.getElementById('editAddress');
      
      console.log('Form elements found:', {
        firstNameInput: !!firstNameInput,
        lastNameInput: !!lastNameInput,
        firstNameInputValue: firstNameInput?.value,
        lastNameInputValue: lastNameInput?.value,
        storedData: currentEditCustomerData
      });
      
      if (!firstNameInput || !lastNameInput) {
        alert('Error: Form fields not found. Please refresh the page and try again.');
        console.error('Form fields missing:', { firstNameInput, lastNameInput });
        return;
      }
      
      // Get raw values from form, with fallback to stored data
      let firstNameRaw = firstNameInput.value || '';
      let lastNameRaw = lastNameInput.value || '';
      let emailRaw = emailInput ? (emailInput.value || '') : '';
      let phoneRaw = phoneInput ? (phoneInput.value || '') : '';
      let addressRaw = addressInput ? (addressInput.value || '') : '';
      
      // If form values are empty, use stored data as fallback
      if ((!firstNameRaw || firstNameRaw.trim() === '') && currentEditCustomerData) {
        console.warn('First name empty in form, using stored data');
        firstNameRaw = currentEditCustomerData.firstName || '';
      }
      if ((!lastNameRaw || lastNameRaw.trim() === '') && currentEditCustomerData) {
        console.warn('Last name empty in form, using stored data');
        lastNameRaw = currentEditCustomerData.lastName || '';
      }
      if ((!emailRaw || emailRaw.trim() === '') && currentEditCustomerData) {
        emailRaw = currentEditCustomerData.email || '';
      }
      if ((!phoneRaw || phoneRaw.trim() === '') && currentEditCustomerData) {
        phoneRaw = currentEditCustomerData.phone || '';
      }
      if ((!addressRaw || addressRaw.trim() === '') && currentEditCustomerData) {
        addressRaw = currentEditCustomerData.address || '';
      }
      
      // Trim values
      const firstName = String(firstNameRaw).trim();
      const lastName = String(lastNameRaw).trim();
      const email = String(emailRaw).trim();
      const phone = String(phoneRaw).trim();
      const address = String(addressRaw).trim();
      
      console.log('Form values before submission:', { 
        firstName, 
        lastName, 
        email, 
        phone, 
        address,
        firstNameRaw,
        lastNameRaw,
        firstNameLength: firstName.length,
        lastNameLength: lastName.length,
        firstNameInputExists: !!firstNameInput,
        lastNameInputExists: !!lastNameInput,
        firstNameInputValueDirect: firstNameInput.value,
        lastNameInputValueDirect: lastNameInput.value
      }); // Debug log
      
      // Validate required fields
      if (!firstName || firstName.length === 0) {
        alert('First name is required! Current value: "' + firstNameRaw + '"');
        firstNameInput.focus();
        console.error('First name validation failed:', { firstName, firstNameRaw, inputValue: firstNameInput.value });
        return;
      }
      
      if (!lastName || lastName.length === 0) {
        alert('Last name is required! Current value: "' + lastNameRaw + '"');
        lastNameInput.focus();
        console.error('Last name validation failed:', { lastName, lastNameRaw, inputValue: lastNameInput.value });
        return;
      }
      
      const customerData = {
        FirstName: firstName,
        LastName: lastName,
        Email: email,
        Phone: phone || null,
        UserPassword: passwordToUse,
        Address: address || null
      };

      console.log('Updating customer:', id, customerData); // Debug log

      try {
        const response = await fetch(`${getApiBaseUrl()}/customers/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(customerData)
        });

        console.log('Update response status:', response.status); // Debug log

        if (!response.ok) {
          const errorText = await response.text();
          console.error('Update error response:', errorText);
          let errorData;
          try {
            errorData = JSON.parse(errorText);
          } catch {
            errorData = { message: errorText || `Update failed: ${response.status}` };
          }
          throw new Error(errorData.message || `Update failed: ${response.status}`);
        }

        // Try to get response data
        const responseData = await response.json().catch(() => null);
        console.log('Update response data:', responseData); // Debug log

        // Close modal and reload
        const modal = bootstrap.Modal.getInstance(document.getElementById('editCustomerModal'));
        modal.hide();
        form.reset();
        currentCustomerPassword = ''; // Reset password cache
        
        // Reload immediately
        await loadCustomers();
        alert('Customer updated successfully!');
      } catch (error) {
        console.error('Error updating customer:', error);
        alert('Error updating customer: ' + error.message);
      }
    }

    loadCustomers();
  </script>
</body>
</html>


